<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FactLens 明鉴AI - 四维分析</title>

  <!-- 国内可访问、带版本号的 CDN -->
  <script src="https://cdn.tailwindcss.com/3.4.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <!-- 新增：html2canvas 用于生成海报 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{--primary-color:#1a1d29;--secondary-color:#6b7280;--accent-color:#3b82f6;--fact-color:#1e40af;--opinion-color:#059669;--bias-color:#dc2626;--bg-color:#ffffff;--text-color:#111827}
    body{font-family:'Noto Sans SC',sans-serif;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);min-height:100vh}
    .hero-title{font-family:'Noto Serif SC',serif;font-weight:700;background:linear-gradient(135deg,var(--accent-color),#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .analysis-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .url-input{@apply w-full px-4 py-3 pr-12 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none;border:2px solid #e5e7eb;transition:all .3s ease}
    .url-input:focus{border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .analyze-btn{@apply w-full lg:w-auto px-12 py-4 text-white font-semibold rounded-lg flex items-center justify-center space-x-2 text-lg; background:linear-gradient(135deg,var(--accent-color),#8b5cf6);transition:all .3s ease}
    .analyze-btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(59,130,246,.3)}
    .analyze-btn:disabled{opacity:.6;cursor:not-allowed}
    .loading-spinner{animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .fade-in{animation:fadeIn .5s ease-in}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .section-fact{border-left:4px solid var(--fact-color)}.section-opinion{border-left:4px solid var(--opinion-color)}.section-bias{border-left:4px solid var(--bias-color)}
    .mono-font{font-family:'JetBrains Mono',monospace}
    /* 模态框背景 */
    .modal-bg{background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}

    /* ===== 海报分享按钮 ===== */
    .share-poster-btn{@apply inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium text-white bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 transition-all;}
    /* ===== 海报容器：竖版长图，仅生成时用 ===== */
    #poster-container{
      position:absolute;
      left:-9999px;
      top:0;
      width:720px;          /* 竖版：宽 720，高按内容自动延伸 */
      background:#ffffff;
      padding:48px 56px;
      font-family:'Noto Sans SC',sans-serif;
      color:#111827;
      line-height:1.6;
    }
    #poster-container .poster-title{
      font-family:'Noto Serif SC',serif;
      font-weight:700;
      font-size:40px;
      background:linear-gradient(135deg,#3b82f6,#8b5cf6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:32px;
      text-align:center;
    }
    #poster-container .poster-section-title{
      font-weight:600;
      font-size:24px;
      margin-top:36px;
      margin-bottom:12px;
      border-left:6px solid #3b82f6;
      padding-left:12px;
    }
    #poster-container .poster-fact{
      border-left-color:#1e40af;
    }
    #poster-container .poster-opinion{
      border-left-color:#059669;
    }
    #poster-container .poster-bias{
      border-left-color:#dc2626;
    }
    #poster-container .poster-list{
      font-size:20px;
      font-weight:400;
      margin-left:18px;
      margin-bottom:8px;
    }
    #poster-container .poster-summary{
      font-size:22px;
      font-weight:500;
      margin-top:40px;
      padding:24px;
      background:#f8fafc;
      border-radius:12px;
    }
    #poster-container .poster-footer{
      margin-top:48px;
      text-align:center;
      font-size:18px;
      color:#6b7280;
    }
  </style>
</head>
<body class="text-gray-900">
  <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"><i class="fas fa-search text-white text-sm"></i></div>
          <h1 class="text-xl font-semibold text-gray-900">FactLens 明鉴AI</h1>
        </div>
        <div class="flex space-x-6"><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">首页</a><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">关于</a><a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">示例</a></div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-12">
      <h1 class="hero-title text-4xl md:text-6xl font-bold mb-4">明鉴AI深度分析</h1>
      <p class="text-2xl text-gray-800 font-medium mb-4">明鉴事实，洞见观点</p>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-8">输入网址，即刻获得「事实-观点-偏见」三色拆解报告</p>
    </div>

    <!-- INPUT -->
    <div class="analysis-card rounded-2xl p-8 mb-8">
      <label for="url-input" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-link mr-2 text-blue-500"></i>输入要分析的网页URL</label>
      <div class="relative">
        <input type="url" id="url-input" placeholder="https://example.com/article" class="url-input w-full px-4 py-3 pr-12 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none">
        <button id="clear-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"><i class="fas fa-times-circle"></i></button>
      </div>
      <div class="relative flex items-center justify-center my-6"><div class="w-full border-t border-gray-300"></div><div class="relative bg-white px-4"><span class="text-sm text-gray-500">或</span></div></div>

      <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-alt mr-2 text-green-500"></i>粘贴文本内容进行分析</label>
      <textarea id="text-input" rows="6" placeholder="在此粘贴您要分析的文本内容..." class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-green-500 focus:outline-none resize-none"></textarea>
      <div class="flex justify-between items-center mt-2"><div class="text-xs text-gray-500">支持直接粘贴文本内容进行分析</div><button id="clear-text-btn" class="text-xs text-gray-400 hover:text-gray-600 hidden"><i class="fas fa-times mr-1"></i>清空文本</button></div>

      <div class="text-center mt-6"><button id="analyze-btn" class="analyze-btn w-full lg:w-auto px-12 py-4 text-white font-semibold rounded-lg flex items-center justify-center space-x-2 text-lg"><i class="fas fa-search"></i><span>明鉴一下</span></button></div>
      <div id="progress-section" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
        <div class="flex items-center space-x-3 mb-3"><div class="loading-spinner w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div><span id="progress-text" class="text-blue-700 font-medium">正在获取网页内容...</span></div>
        <div class="w-full bg-blue-200 rounded-full h-2"><div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="summary-banner" class="analysis-card rounded-2xl p-6 mb-6 hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center"><i class="fas fa-quote-left text-blue-500 mr-3"></i><span class="text-gray-700 font-medium">报告总结论：</span></div>
        <!-- 新增：海报分享按钮 -->
        <button id="share-poster-btn" class="share-poster-btn hidden"><i class="fas fa-image mr-2"></i>生成分享海报</button>
      </div>
      <p id="total-conclusion" class="text-gray-900 text-lg mt-2 leading-relaxed">正在生成结论…</p>
    </div>

    <!-- 4D CARD -->
    <div id="four-dim-card" class="analysis-card rounded-2xl p-8 mb-8 hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4"><i class="fas fa-chart-line text-blue-500 mr-2"></i>四维分析</h2>
      <div class="flex items-center justify-between mb-4"><span id="badge-level" class="px-3 py-1 rounded-full text-sm font-semibold text-white bg-gradient-to-r from-blue-500 to-purple-600">A 级</span><span id="badge-text" class="text-sm text-gray-600">高可信度</span></div>
      <div class="space-y-3 text-sm">
        <div class="flex items-center justify-between"><span>情绪中立度</span><span id="eb-score" class="mono-font text-orange-600">0</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div id="eb-bar" class="bg-orange-500 h-2 rounded-full" style="width:0%"></div></div>
        <div class="flex items-center justify-between"><span>信源透明度</span><span id="ts-score" class="mono-font">0</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div id="ts-bar" class="bg-blue-600 h-2 rounded-full" style="width:0%"></div></div>
        <div class="flex items-center justify-between"><span>事实密度</span><span id="fd-score" class="mono-font">0</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div id="fd-bar" class="bg-green-600 h-2 rounded-full" style="width:0%"></div></div>
        <div class="flex items-center justify-between"><span>一致性</span><span id="cs-score" class="mono-font">0</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div id="cs-bar" class="bg-purple-600 h-2 rounded-full" style="width:0%"></div></div>
      </div>
      <details class="mt-4"><summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">展开雷达图</summary><div class="mt-2 h-64"><canvas id="radar-canvas"></canvas></div></details>
    </div>

    <!-- RESULTS -->
    <div id="results-section" class="hidden">
      <div class="grid lg:grid-cols-3 gap-8 mb-8">
        <div class="analysis-card rounded-2xl p-6 section-fact"><div class="flex items-center mb-4"><div class="w-3 h-3 bg-blue-600 rounded-full mr-3"></div><h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-check-circle text-blue-600 mr-2"></i>哪些是事实</h3></div><div id="facts-list" class="space-y-2"><div class="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg">正在分析事实内容...</div></div></div>
        <div class="analysis-card rounded-2xl p-6 section-opinion"><div class="flex items-center mb-4"><div class="w-3 h-3 bg-green-600 rounded-full mr-3"></div><h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-lightbulb text-green-600 mr-2"></i>哪些是观点</h3></div><div id="opinions-list" class="space-y-2"><div class="text-sm text-gray-700 bg-green-50 p-3 rounded-lg">正在分析观点内容...</div></div></div>
        <div class="analysis-card rounded-2xl p-6 section-bias"><div class="flex items-center mb-4"><div class="w-3 h-3 bg-red-600 rounded-full mr-3"></div><h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>是否有偏见</h3></div>
          <div class="space-y-3">
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">情绪化词汇</span><span id="emotional-words" class="mono-font font-medium text-red-600">分析中...</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">二元对立</span><span id="binary-opposition" class="mono-font font-medium text-red-600">分析中...</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">动机揣测</span><span id="motivation-guessing" class="mono-font font-medium text-red-600">分析中...</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">整体倾向</span><span id="overall-tendency" class="mono-font font-medium text-green-600">分析中...</span></div>
          </div>
        </div>
      </div>
      <div class="grid lg:grid-cols-2 gap-8">
        <div class="analysis-card rounded-2xl p-6"><h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-edit text-purple-500 mr-2"></i>对内容发布者的建议</h3><p id="publisher-recommendation" class="text-gray-700 leading-relaxed">正在生成专业建议...</p></div>
        <div class="analysis-card rounded-2xl p-6"><h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-comments text-green-500 mr-2"></i>公关回应建议</h3><p id="pr-recommendation" class="text-gray-700 leading-relaxed">正在生成公关建议...</p></div>
      </div>
    </div>
  </main>

  <!-- ===== 海报容器（生成时离屏渲染） ===== -->
  <div id="poster-container">
    <div class="poster-title">明鉴AI 深度分析报告</div>
    <div id="poster-summary" class="poster-summary"></div>

    <div class="poster-section-title poster-fact">事实要点</div>
    <div id="poster-facts" class="poster-list"></div>

    <div class="poster-section-title poster-opinion">观点归纳</div>
    <div id="poster-opinions" class="poster-list"></div>

    <div class="poster-section-title poster-bias">偏见提示</div>
    <div id="poster-bias" class="poster-list"></div>

    <div class="poster-footer">
      生成于 <span id="poster-date"></span> · FactLens 明鉴AI
    </div>
  </div>

  <!-- 页脚：隐私政策 + 用户协议 -->
  <footer class="bg-gray-50 border-t border-gray-200 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-gray-600">
      <div class="mb-2">
        <button onclick="openModal('privacy')" class="text-gray-500 hover:text-blue-600 mx-2">隐私政策</button>
        ·
        <button onclick="openModal('terms')" class="text-gray-500 hover:text-blue-600 mx-2">用户协议</button>
      </div>
      <p class="mb-2">© 2025 FactLens 明鉴AI. 专业内容分析工具</p>
      <p class="text-sm">Powered by AI | Designed for Truth</p>
    </div>
  </footer>

  <!-- ===== 模态框 ===== -->
  <div id="modal-bg" class="fixed inset-0 z-50 modal-bg hidden" onclick="closeModal()"></div>
  <div id="modal-panel" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-auto shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-lg font-semibold text-gray-900"></h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
      </div>
      <div id="modal-body" class="text-gray-700 leading-relaxed"></div>
      <div class="mt-6 text-right">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">关闭</button>
      </div>
    </div>
  </div>

  <!-- ===== 模态框内容 ===== -->
  <script>
    const modalData = {
      privacy: {
        title: '隐私政策',
        body: `
          <p>生效日期：2025-10-20</p>
          <p class="mt-2"><strong>1. 信息收集</strong></p>
          <p>我们仅在你主动输入网址或粘贴文本时临时处理相关内容，不会保存、上传或分享给任何第三方。</p>
          <p class="mt-2"><strong>2. 日志与统计</strong></p>
          <p>为改进服务，系统可能记录匿名化的访问日志（IP 脱敏、时间戳、是否成功），该数据不含任何可识别个人身份的信息。</p>
          <p class="mt-2"><strong>3. Cookie 与本地存储</strong></p>
          <p>本服务未使用 Cookie；仅在浏览器本地存储（localStorage）中缓存同一网址的分析结果，以减少重复调用。</p>
          <p class="mt-2"><strong>4. 第三方服务</strong></p>
          <p>我们使用 Moonshot（月之暗面）提供的 Kimi API 进行文本分析，调用过程遵循其<a class="text-blue-600 hover:underline" href="https://platform.moonshot.cn/docs/terms" target="_blank">服务条款</a>。</p>
          <p class="mt-2"><strong>5. 联系我们</strong></p>
          <p>如对本政策有疑问，请通过页面底部邮箱与我们联系。</p>
        `
      },
      terms: {
        title: '用户协议',
        body: `
          <p>生效日期：2025-10-20</p>
          <p class="mt-2"><strong>1. 接受条款</strong></p>
          <p>使用本站即表示你已阅读并同意本协议；若不同意，请停止使用。</p>
          <p class="mt-2"><strong>2. 使用规范</strong></p>
          <p>不得输入或上传任何违法、暴力、色情、侵权等内容；否则我们有权拒绝服务并封禁相关请求。</p>
          <p class="mt-2"><strong>3. 分析结果</strong></p>
          <p>AI 结论仅供参考，不构成法律、投资、新闻等专业意见，使用者应自行判断并承担风险。</p>
          <p class="mt-2"><strong>4. 服务变更</strong></p>
          <p>我们可随时更新或终止部分功能，恕不另行通知。</p>
          <p class="mt-2"><strong>5. 责任限制</strong></p>
          <p>在适用法律允许范围内，我们对因使用或无法使用本服务而产生的任何直接、间接损失不承担责任。</p>
        `
      }
    };

    function openModal(type) {
      const data = modalData[type];
      $('modal-title').innerText = data.title;
      $('modal-body').innerHTML = data.body;
      $('modal-bg').classList.remove('hidden');
      $('modal-panel').classList.remove('hidden');
    }
    function closeModal() {
      $('modal-bg').classList.add('hidden');
      $('modal-panel').classList.add('hidden');
    }
  </script>

  <script>
    /* ===== 保护：Chart 加载失败也不阻断后续 ===== */
    window.Chart = window.Chart || false;

    /* ===== 通用工具 ===== */
    const $ = id => document.getElementById(id);

    /* ===== 增强抓取：自动重试 + 软拦截检测 ===== */
    async function fetchText(url, maxTry = 2) {
      const mirrors = [
        u => `https://r.jina.ai/${encodeURIComponent(u)}?chunk_num=1&chunk_order=0&html=false`,
        u => `https://s.jina.ai/${encodeURIComponent(u)}`
      ];
      for (let i = 0; i < mirrors.length; i++) {
        try {
          const res = await fetch(mirrors[i](url), { signal: AbortSignal.timeout(8000) });
          if (!res.ok) continue;
          const text = await res.text();
          if (/(请完成验证|Sina Visitor System|百度安全验证|需验证|请开启 JavaScript|访客验证|无法访问|403 Forbidden|404 Not Found|Access Denied|Please enable cookies|完成验证后方可继续访问)/i.test(text)) {
            console.warn('[FactLens] 遇到验证页，尝试下一镜像');
            continue;
          }
          return text;
        } catch (e) {
          if (i === mirrors.length - 1) throw e;
        }
      }
      throw new Error('NO_VALID_BODY');
    }

    /* ===== 增强校验：长度+关键词 ===== */
    function isValidBody(text) {
      if (!text || text.length < 60) return false;
      const invalid = /(请完成验证|百度安全验证|Sina Visitor System|请开启 JavaScript|访客验证|无法访问|403 Forbidden|404 Not Found|Access Denied|Please enable cookies|完成验证后方可继续访问)/i;
      return !invalid.test(text);
    }

    function buildPrompt(content, title) {
      return `【角色】
你是明鉴AI——一个专门做「事实-观点-偏见」三色拆解的内容鉴定器。
输出必须严格遵循下方【格式规范】，否则下游解析器会报错。

【思考步骤】
Step-1 通读全文，用两句话以内概括原文核心信息。
Step-2 把文中所有陈述按句切分，每句先判断"是否可证伪"，再归入<fact>或<opinion>。
Step-3 对<opinion>句进一步做偏见扫描：标出情绪化词汇、二元对立、动机揣测、逻辑谬误，并给出原文片段。

【格式规范】
| 明鉴·FactLens 报告 |
|------------------|
| 标题：${title} |
| 可信度：X / 10（一句话理由）|

#### 事实区（≤8 条，每条≤40 字，必须可证伪）
1. <fact>xxx</fact>
...

#### 观点区（≤8 条，每条≤40 字，必须不可证伪）
1. <opinion>xxx</opinion>

#### 偏见指标
- 情绪化词汇：X 处；示例：<eg>原句1</eg>|<eg>原句2</eg>
- 二元对立：X 组；示例：<eg>原句</eg>
- 动机揣测：X 处；示例：<eg>原句</eg>
- 逻辑谬误：X 处；类型：<type>滑坡/稻草人/诉诸权威</type>；示例：<eg>原句</eg>
- 整体倾向：批判/中性/赞扬 X%（按句子数占比估）

#### 对内容发布者的建议（≤100 字，必须可执行，禁止写"无"）
【场景】${title}
【问题】{{用一句话指出 1 个最大风险或短板}}
【行动】{{给出 1 条最应立即执行的补救动作，用动词开头，量化优先}}
xxx

#### 公关回应建议（≤100 字，必须可执行，禁止写"无"）
【场景】${title}
【舆情风险】{{用一句话指出公众最可能误解的点}}
【回应要点】{{给出 1 条可直接发布的回应口径，含时间节点/数据/引用来源，≤100 字}}
xxx

#### 报告总结论（≤80 字）
用第三人称、两句话以内概括原文核心信息，禁止出现"作者""本文"字样。
xxx

【正文】
${content}`;
    }
    async function analyzeWithKimi(content, title) {
      const prompt = buildPrompt(content, title);
      const body = { model: 'moonshot-v1-8k', messages: [{ role: 'user', content: prompt }], temperature: 0.25, max_tokens: 2048 };
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) { const t = await res.text(); throw new Error(`Moonshot API ${res.status}: ${t}`); }
      return (await res.json()).choices[0].message.content;
    }
    function parseKimiResponse(md) {
      const r = { title: '', credibility: 0, reason: '', facts: [], opinions: [], bias: { emotionalWords: 0, binaryOpposition: 0, motivationGuessing: 0, logicalFallacy: 0, overallTendency: '中性 0%' }, summaryForBanner: '', publisherRecommendation: '', recommendation: '' };
      const mCred = md.match(/可信度[:：]\s*(\d+(?:\.\d+)?)\s*\/\s*10\s*（(.+?)）/);
      if (mCred) { r.credibility = parseFloat(mCred[1]); r.reason = mCred[2]; }
      const mTitle = md.match(/标题[:：]\s*(.+?)(?:\n|\||$)/);
      if (mTitle) r.title = mTitle[1].trim();
      const fBlock = md.match(/#### 事实区[\s\S]*?(?=#### 观点区)/);
      if (fBlock) r.facts = fBlock[0].split('\n').filter(l => /^\d+\./.test(l)).map(l => l.replace(/^\d+\.\s*<fact>(.*)<\/fact>.*/, '$1').trim()).filter(Boolean);
      const oBlock = md.match(/#### 观点区[\s\S]*?(?=#### 偏见指标)/);
      if (oBlock) r.opinions = oBlock[0].split('\n').filter(l => /^\d+\./.test(l)).map(l => l.replace(/^\d+\.\s*<opinion>(.*)<\/opinion>.*/, '$1').trim()).filter(Boolean);
      const bBlock = md.match(/#### 偏见指标[\s\S]*?(?=#### 对内容发布者的建议)/);
      if (bBlock) {
        const b = bBlock[0];
        const emo = b.match(/情绪化词汇[:：]\s*(\d+)\s*处/);
        const bin = b.match(/二元对立[:：]\s*(\d+)\s*组/);
        const mot = b.match(/动机揣测[:：]\s*(\d+)\s*处/);
        const fall = b.match(/逻辑谬误[:：]\s*(\d+)\s*处/);
        const tend = b.match(/整体倾向[:：]\s*([\u4e00-\u9fa5]+\s*\d+%|\d+%\s*[\u4e00-\u9fa5]+)/);
        if (emo) r.bias.emotionalWords = parseInt(emo[1]);
        if (bin) r.bias.binaryOpposition = parseInt(bin[1]);
        if (mot) r.bias.motivationGuessing = parseInt(mot[1]);
        if (fall) r.bias.logicalFallacy = parseInt(fall[1]);
        if (tend) r.bias.overallTendency = tend[1].trim();
      }
      const pub = md.match(/#### 对内容发布者的建议[\s\S]*?\n【行动】\s*(.+?)\s*(?=####|$)/s);
      if (pub) r.publisherRecommendation = pub[1].replace(/\s+/g,' ').trim();
      const pr  = md.match(/#### 公关回应建议[\s\S]*?\n【回应要点】\s*(.+?)\s*(?=####|$)/s);
      if (pr) r.recommendation = pr[1].replace(/\s+/g,' ').trim();
      const banner = md.match(/#### 报告总结论（≤80 字）\s*\n([\s\S]*?)(?=###|\|$$|\n*$|$)/);
      if (banner) r.summaryForBanner = banner[1].replace(/\s+/g,' ').trim();
      return r;
    }

    /* ===== DOM 绑定 ===== */
    document.addEventListener('DOMContentLoaded', () => {
      const analyzeBtn = $('analyze-btn'), sampleBtn = $('sample-btn'), urlInput = $('url-input'), textInput = $('text-input'), progressSection = $('progress-section'), resultsSection = $('results-section'), fourDimCard = $('four-dim-card'), clearBtn = $('clear-btn'), clearTextBtn = $('clear-text-btn'), sharePosterBtn = $('share-poster-btn');
      function toggleBtn() {
        const u = urlInput.value.trim(), t = textInput.value.trim(), has = !!(u || t);
        analyzeBtn.disabled = !has;
        analyzeBtn.classList.toggle('opacity-50', !has);
        clearBtn.classList.toggle('hidden', !u);
        clearTextBtn.classList.toggle('hidden', !t);
      }
      urlInput.addEventListener('input', () => { if (urlInput.value) textInput.value = ''; toggleBtn(); });
      textInput.addEventListener('input', () => { if (textInput.value) urlInput.value = ''; toggleBtn(); });
      clearBtn.addEventListener('click', () => { urlInput.value = ''; toggleBtn(); urlInput.focus(); });
      clearTextBtn.addEventListener('click', () => { textInput.value = ''; toggleBtn(); textInput.focus(); });
      urlInput.addEventListener('paste', e => setTimeout(() => urlInput.dispatchEvent(new Event('input')), 0));
      analyzeBtn.addEventListener('click', startAnalysis);
      sampleBtn.addEventListener('click', () => { alert('示例功能已移除，请输入URL或粘贴文本进行真实分析。'); urlInput.focus(); });
      sharePosterBtn.addEventListener('click', generatePoster);

      async function startAnalysis() {
        console.log('[FactLens] 按钮已点击');
        const url = urlInput.value.trim(), text = textInput.value.trim();
        if (!url && !text) return;
        progressSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        fourDimCard.classList.add('hidden');
        $('summary-banner').classList.add('hidden');
        sharePosterBtn.classList.add('hidden');

        try {
          let content = '', title = '';
          if (url) {
            $('progress-text').textContent = '正在获取网页内容...';
            $('progress-bar').style.width = '20%';
            content = await fetchText(url);
            if (!isValidBody(content)) throw new Error('NO_VALID_BODY');
            const MAX_INPUT = 3500;
            if (content.length > MAX_INPUT) content = content.slice(0, MAX_INPUT) + '……';
            title = url;
          } else {
            $('progress-text').textContent = '正在处理文本内容...';
            $('progress-bar').style.width = '20%';
            content = text.slice(0, 3500);
            title = '直接粘贴的文本内容';
          }
          $('progress-text').textContent = 'AI深度分析中...';
          $('progress-bar').style.width = '60%';
          const kimiMd = await analyzeWithKimi(content, title);
          $('progress-text').textContent = '生成可信度报告...';
          $('progress-bar').style.width = '100%';
          displayResults(parseKimiResponse(kimiMd));
        } catch (err) {
          $('progress-text').textContent = '分析失败';
          $('progress-bar').style.width = '100%';
          // 仅保留指定结论，不再出现其他提示
          $('total-conclusion').textContent =
            '因网站设置原因，明鉴AI无法访问原始内容，请复制粘贴文本内容直接进行分析。';
          $('summary-banner').classList.remove('hidden');
          resultsSection.classList.add('hidden');
          fourDimCard.classList.add('hidden');
          setTimeout(() => progressSection.classList.add('hidden'), 1500);
          return;
        }

        setTimeout(() => {
          progressSection.classList.add('hidden');
          resultsSection.classList.remove('hidden');
          fourDimCard.classList.remove('hidden');
          resultsSection.classList.add('fade-in');
          fourDimCard.classList.add('fade-in');
          sharePosterBtn.classList.remove('hidden');
        }, 1000);
      }

      function displayResults(d) {
        const ts = Math.min(10, 0.5 + (d.credibility || 8.5));
        const ebRaw = d.bias.emotionalWords + d.bias.binaryOpposition + d.bias.motivationGuessing;
        const eb = Math.max(0, 10 - ebRaw * 1.2);
        let biasTxt = '';
        if (ebRaw === 0)       biasTxt = '基本中立';
        else if (ebRaw <= 2)   biasTxt = '略有倾向';
        else if (ebRaw <= 4)   biasTxt = '存在明显偏见';
        else                   biasTxt = '存在严重偏见';
        const stance = eb >= 8 ? '客观中立' : eb >= 6 ? '有失偏颇' : '不够客观';
        const conclusion = d.summaryForBanner
          ? `${d.summaryForBanner} 这是一篇${stance}的报道，${biasTxt}。`
          : `这是一篇${stance}的报道，${biasTxt}。`;
        $('total-conclusion').textContent = conclusion;
        $('summary-banner').classList.remove('hidden');

        const factsList = $('facts-list');
        factsList.innerHTML = d.facts.length ? d.facts.map((f, i) => `<div class="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg">${i + 1}. ${f}</div>`).join('') : '<div class="text-sm text-gray-500">未检测到明确的事实陈述</div>';
        const opList = $('opinions-list');
        opList.innerHTML = d.opinions.length ? d.opinions.map((o, i) => `<div class="text-sm text-gray-700 bg-green-50 p-3 rounded-lg">${i + 1}. ${o}</div>`).join('') : '<div class="text-sm text-gray-500">未检测到明确的观点表达</div>';
        $('emotional-words').textContent = d.bias.emotionalWords + ' 处';
        $('binary-opposition').textContent = d.bias.binaryOpposition + ' 组';
        $('motivation-guessing').textContent = d.bias.motivationGuessing + ' 处';
        $('overall-tendency').textContent = d.bias.overallTendency || '中性 0%';
        $('publisher-recommendation').textContent = d.publisherRecommendation || '建议提升内容质量';
        $('pr-recommendation').textContent = d.recommendation || '建议谨慎处理';

        const fd = Math.min(10, 1.5 + (d.facts.length || 0) * 1.8);
        const cs = Math.min(10, 0.5 + (ts + fd + eb) / 3);
        $('eb-score').textContent = eb.toFixed(1);
        $('ts-score').textContent = ts.toFixed(1);
        $('fd-score').textContent = fd.toFixed(1);
        $('cs-score').textContent = cs.toFixed(1);

        const ebPercent = eb * 10;
        const hue        = 34 - (ebPercent * 0.34);
        const lightness  = 55 - (ebPercent * 0.15);
        const barColor   = `hsl(${hue}, 90%, ${lightness}%)`;
        $('eb-bar').style.cssText = `width:${ebPercent.toFixed(0)}%;background:${barColor}`;
        $('ts-bar').style.cssText = `width:${(ts * 10).toFixed(0)}%;background-color:#2563eb`;
        $('fd-bar').style.cssText = `width:${(fd * 10).toFixed(0)}%;background-color:#16a34a`;
        $('cs-bar').style.cssText = `width:${(cs * 10).toFixed(0)}%;background-color:#9333ea`;

        const avg = (ts + fd + eb + cs) / 4;
        let lvl = 'D', txt = '低可信度';
        if (avg >= 8.5) { lvl = 'A'; txt = '高可信度'; } else if (avg >= 7) { lvl = 'B'; txt = '中等可信度'; } else if (avg >= 5) { lvl = 'C'; txt = '偏低可信度'; }
        $('badge-level').textContent = lvl + ' 级';
        $('badge-text').textContent = txt;
        drawRadar([ts, fd, eb, cs]);

        // 缓存数据到 poster 容器
        window.posterData = {
          conclusion,
          facts: d.facts,
          opinions: d.opinions,
          bias: d.bias
        };
      }

      function drawRadar(data) {
        if (!window.Chart) {
          console.warn('[FactLens] Chart.js 未加载，雷达图跳过');
          return;
        }
        const ctx = $('radar-canvas');
        if (window.radarInstance) window.radarInstance.destroy();
        window.radarInstance = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['信源透明度', '事实密度', '情绪中立度', '一致性'],
            datasets: [{ label: '得分', data: data, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', pointBackgroundColor: 'rgba(59, 130, 246, 1)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(59, 130, 246, 1)' }]
          },
          options: { scales: { r: { angleLines: false, suggestedMin: 0, suggestedMax: 10 } }, plugins: { legend: { display: false } } }
        });
      }

      /* ===== 海报生成函数 ===== */
      async function generatePoster(){
        if (!window.posterData) return;
        const d = window.posterData;
        // 填充离屏容器
        $('poster-summary').textContent = d.conclusion;
        $('poster-facts').innerHTML = d.facts.map((f,i)=>`<div>${i+1}. ${f}</div>`).join('');
        $('poster-opinions').innerHTML = d.opinions.map((o,i)=>`<div>${i+1}. ${o}</div>`).join('');
        $('poster-bias').innerHTML = `
          <div>情绪化词汇：${d.bias.emotionalWords} 处</div>
          <div>二元对立：${d.bias.binaryOpposition} 组</div>
          <div>动机揣测：${d.bias.motivationGuessing} 处</div>
          <div>整体倾向：${d.bias.overallTendency}</div>
        `;
        $('poster-date').textContent = new Date().toLocaleString('zh-CN');

        const poster = $('poster-container');
        try {
          // 使用 html2canvas 渲染
          const canvas = await html2canvas(poster, {
            width: 720,
            scale: 2, // 2 倍清晰度
            backgroundColor: '#ffffff',
            useCORS: true
          });
          // 下载
          canvas.toBlob(blob=>{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FactLens_明鉴报告_${Date.now()}.png`;
            a.click();
            URL.revokeObjectURL(url);
          }, 'image/png');
        } catch (err) {
          console.error('[FactLens] 海报生成失败', err);
          alert('海报生成失败，请重试');
        }
      }
    });
  </script>
</body>
</html>
