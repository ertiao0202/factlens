<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactLens 明鉴AI - 事实·观点·偏见深度分析</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.3/plotly.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a1d29;
            --secondary-color: #6b7280;
            --accent-color: #3b82f6;
            --fact-color: #1e40af;
            --opinion-color: #059669;
            --bias-color: #dc2626;
            --bg-color: #ffffff;
            --text-color: #111827;
        }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .hero-title {
            font-family: 'Noto Serif SC', serif;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .analysis-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .url-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .url-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .analyze-btn {
            background: linear-gradient(135deg, var(--accent-color), #8b5cf6);
            transition: all 0.3s ease;
        }
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .credibility-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .section-fact { border-left: 4px solid var(--fact-color); }
        .section-opinion { border-left: 4px solid var(--opinion-color); }
        .section-bias { border-left: 4px solid var(--bias-color); }
        .mono-font {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-search text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">FactLens 明鉴AI</h1>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">首页</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">关于</a>
                    <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors">示例</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center mb-12">
            <h1 class="hero-title text-4xl md:text-6xl font-bold mb-4">
                明鉴AI深度分析
            </h1>
            <p class="text-2xl text-gray-800 font-medium mb-4">
                明鉴事实，洞见观点
            </p>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-8">
                输入网址，即刻获得「事实-观点-偏见」三色拆解报告
            </p>
        </div>

        <!-- 输入区域（仅插入文本框 & 或分割线，其余不动） -->
        <div class="analysis-card rounded-2xl p-8 mb-8">
            <!-- URL 输入 -->
            <label for="url-input" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-link mr-2 text-blue-500"></i>输入要分析的网页URL
            </label>
            <div class="relative">
                <input 
                    type="url" 
                    id="url-input" 
                    placeholder="https://example.com/article"
                    class="url-input w-full px-4 py-3 pr-12 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none"
                >
                <button 
                    id="clear-btn" 
                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
                    title="清空输入框"
                >
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>

            <!-- 或 -->
            <div class="relative flex items-center justify-center my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative bg-white px-4">
                    <span class="text-sm text-gray-500">或</span>
                </div>
            </div>

            <!-- 文本粘贴（仅此新增） -->
            <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-file-alt mr-2 text-green-500"></i>粘贴文本内容进行分析
            </label>
            <textarea 
                id="text-input" 
                rows="6" 
                placeholder="在此粘贴您要分析的文本内容..."
                class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-green-500 focus:outline-none resize-none"
            ></textarea>
            <div class="flex justify-between items-center mt-2">
                <div class="text-xs text-gray-500">支持直接粘贴文本内容进行分析</div>
                <button id="clear-text-btn" class="text-xs text-gray-400 hover:text-gray-600 hidden">
                    <i class="fas fa-times mr-1"></i>清空文本
                </button>
            </div>

            <!-- 开始分析按钮 -->
            <div class="text-center mt-6">
                <button 
                    id="analyze-btn" 
                    class="analyze-btn w-full lg:w-auto px-8 py-3 text-white font-semibold rounded-lg flex items-center justify-center space-x-2"
                >
                    <i class="fas fa-search"></i>
                    <span>开始分析</span>
                </button>
            </div>

            <!-- 进度条 -->
            <div id="progress-section" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="loading-spinner w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                    <span id="progress-text" class="text-blue-700 font-medium">正在获取内容...</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 结果展示区（与你上一版完全一致） -->
        <div id="results-section" class="hidden">
            <!-- 可信度评分 -->
            <div class="analysis-card rounded-2xl p-8 mb-8">
                <div class="flex flex-col lg:flex-row items-center justify-between">
                    <div class="lg:w-1/2 mb-6 lg:mb-0">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-shield-alt text-blue-500 mr-2"></i>可信度评估
                        </h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">标题</span>
                                <span id="report-title" class="font-medium text-gray-900">分析中...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">可信度评分</span>
                                <span id="credibility-score" class="text-2xl font-bold text-blue-600">分析中...</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <span id="credibility-reason">正在分析内容可信度...</span>
                            </div>
                        </div>
                    </div>
                    <div class="lg:w-1/2 flex justify-center">
                        <div id="credibility-chart" class="w-48 h-48"></div>
                    </div>
                </div>
            </div>

            <!-- 三色拆解 -->
            <div class="grid lg:grid-cols-3 gap-8 mb-8">
                <div class="analysis-card rounded-2xl p-6 section-fact">
                    <div class="flex items-center mb-4">
                        <div class="w-3 h-3 bg-blue-600 rounded-full mr-3"></div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-check-circle text-blue-600 mr-2"></i>哪些是事实
                        </h3>
                    </div>
                    <div id="facts-list" class="space-y-2">
                        <div class="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg">正在分析事实内容...</div>
                    </div>
                </div>

                <div class="analysis-card rounded-2xl p-6 section-opinion">
                    <div class="flex items-center mb-4">
                        <div class="w-3 h-3 bg-green-600 rounded-full mr-3"></div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-lightbulb text-green-600 mr-2"></i>哪些是观点
                        </h3>
                    </div>
                    <div id="opinions-list" class="space-y-2">
                        <div class="text-sm text-gray-700 bg-green-50 p-3 rounded-lg">正在分析观点内容...</div>
                    </div>
                </div>

                <div class="analysis-card rounded-2xl p-6 section-bias">
                    <div class="flex items-center mb-4">
                        <div class="w-3 h-3 bg-red-600 rounded-full mr-3"></div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>是否有偏见
                        </h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">情绪化词汇</span>
                            <span id="emotional-words" class="mono-font font-medium text-red-600">分析中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">二元对立</span>
                            <span id="binary-opposition" class="mono-font font-medium text-red-600">分析中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">动机揣测</span>
                            <span id="motivation-guessing" class="mono-font font-medium text-red-600">分析中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">整体倾向</span>
                            <span id="overall-tendency" class="mono-font font-medium text-green-600">分析中...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 建议（无一句话摘要，与你上一版一致） -->
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="analysis-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-edit text-purple-500 mr-2"></i>对内容发布者的建议
                    </h3>
                    <p id="publisher-recommendation" class="text-gray-700 leading-relaxed">
                        正在生成专业建议...
                    </p>
                </div>
                <div class="analysis-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-comments text-green-500 mr-2"></i>公关回应建议
                    </h3>
                    <p id="pr-recommendation" class="text-gray-700 leading-relaxed">
                        正在生成公关建议...
                    </p>
                </div>
            </div>
        </div>

        <!-- 示例按钮 -->
        <div id="sample-section" class="text-center mt-12">
            <button id="sample-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors">
                <i class="fas fa-play mr-2"></i>查看示例分析
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-50 border-t border-gray-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center text-gray-600">
                <p class="mb-2">© 2024 FactLens 明鉴AI. 专业内容分析工具</p>
                <p class="text-sm">Powered by AI | Designed for Truth</p>
            </div>
        </div>
    </footer>

    <script>
        // ====== 安全调用：前端无密钥 ======
        const $ = id => document.getElementById(id);

        document.addEventListener('DOMContentLoaded', () => {
            const analyzeBtn = $('analyze-btn');
            const sampleBtn = $('sample-btn');
            const urlInput = $('url-input');
            const textInput = $('text-input');
            const progressSection = $('progress-section');
            const resultsSection = $('results-section');
            const clearBtn = $('clear-btn');
            const clearTextBtn = $('clear-text-btn');

            function toggleBtn() {
                const url = urlInput.value.trim();
                const text = textInput.value.trim();
                const has = !!(url || text);
                analyzeBtn.disabled = !has;
                analyzeBtn.classList.toggle('opacity-50', !has);
                clearBtn.classList.toggle('hidden', !url);
                clearTextBtn.classList.toggle('hidden', !text);
            }
            urlInput.addEventListener('input', () => {
                if (urlInput.value) textInput.value = '';
                toggleBtn();
            });
            textInput.addEventListener('input', () => {
                if (textInput.value) urlInput.value = '';
                toggleBtn();
            });
            clearBtn.addEventListener('click', () => {
                urlInput.value = '';
                toggleBtn();
                urlInput.focus();
            });
            clearTextBtn.addEventListener('click', () => {
                textInput.value = '';
                toggleBtn();
                textInput.focus();
            });
            urlInput.addEventListener('paste', e => setTimeout(toggleBtn, 0));

            analyzeBtn.addEventListener('click', startAnalysis);
            sampleBtn.addEventListener('click', () => {
                alert('示例功能已移除，请输入URL或粘贴文本进行真实分析。');
                urlInput.focus();
            });

            async function startAnalysis() {
                const url = urlInput.value.trim();
                const text = textInput.value.trim();
                if (!url && !text) return;

                progressSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');

                try {
                    $('progress-text').textContent = '正在获取内容...';
                    $('progress-bar').style.width = '20%';

                    let content = '', title = '';
                    if (url) {
                        const jinaResp = await fetch(`https://r.jina.ai/${encodeURIComponent(url)}`);
                        if (!jinaResp.ok) throw new Error('无法获取网页内容');
                        content = await jinaResp.text();
                        if (content.length > 4500) content = content.slice(0, 4500) + '……';
                        title = url;
                    } else if (text) {
                        content = text.slice(0, 4500);
                        title = '直接粘贴的文本内容';
                    }

                    $('progress-text').textContent = 'AI深度分析中...';
                    $('progress-bar').style.width = '60%';

                    const analyzeRes = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content, title })
                    });
                    if (!analyzeRes.ok) throw new Error('分析服务异常');
                    const { markdown } = await analyzeRes.json();

                    $('progress-text').textContent = '生成可信度报告...';
                    $('progress-bar').style.width = '100%';
                    displayResults(parseKimiResponse(markdown));

                } catch (err) {
                    $('progress-text').textContent = '分析失败：' + err.message;
                    $('progress-bar').className = 'bg-red-600 h-2 rounded-full transition-all duration-300';
                    setTimeout(() => progressSection.classList.add('hidden'), 3000);
                    return;
                }

                setTimeout(() => {
                    progressSection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                    resultsSection.classList.add('fade-in');
                }, 1000);
            }

            function parseKimiResponse(md) {
                const r = { title: '', credibility: 0, reason: '', facts: [], opinions: [], bias: { emotionalWords: 0, binaryOpposition: 0, motivationGuessing: 0, overallTendency: '中性 0%' }, summary: '', publisherRecommendation: '', recommendation: '' };
                const mCred = md.match(/可信度[:：]\s*(\d+(?:\.\d+)?)\s*\/\s*10\s*（(.+?)）/);
                if (mCred) { r.credibility = parseFloat(mCred[1]); r.reason = mCred[2]; }
                const mTitle = md.match(/标题[:：]\s*(.+?)(?:\n|\||$)/);
                if (mTitle) r.title = mTitle[1].trim();
                const fBlock = md.match(/#### 事实区[\s\S]*?(?=#### 观点区)/);
                if (fBlock) r.facts = fBlock[0].split('\n').filter(l => /^\d+\./.test(l)).map(l => l.replace(/^\d+\.\s*/, '').trim()).filter(Boolean);
                const oBlock = md.match(/#### 观点区[\s\S]*?(?=#### 偏见指标)/);
                if (oBlock) r.opinions = oBlock[0].split('\n').filter(l => /^\d+\./.test(l)).map(l => l.replace(/^\d+\.\s*/, '').trim()).filter(Boolean);
                const bBlock = md.match(/#### 偏见指标[\s\S]*?(?=#### 对内容发布者的建议)/);
                if (bBlock) {
                    const b = bBlock[0];
                    const emo = b.match(/情绪化词汇[:：]\s*(\d+)\s*处/);
                    const bin = b.match(/二元对立[:：]\s*(\d+)\s*组/);
                    const mot = b.match(/动机揣测[:：]\s*(\d+)\s*处/);
                    const tend = b.match(/整体倾向[:：]\s*([\u4e00-\u9fa5]+\s*\d+%|\d+%\s*[\u4e00-\u9fa5]+)/);
                    if (emo) r.bias.emotionalWords = parseInt(emo[1]);
                    if (bin) r.bias.binaryOpposition = parseInt(bin[1]);
                    if (mot) r.bias.motivationGuessing = parseInt(mot[1]);
                    if (tend) r.bias.overallTendency = tend[1].trim();
                }
                const sum = md.match(/#### 一句话摘要[\s\S]*?\n\s*(.+?)\s*(?=####)/);
                if (sum) r.summary = sum[1].trim();
                const pub = md.match(/#### 对内容发布者的建议[\s\S]*?\n\s*(.+?)\s*(?=####)/);
                if (pub) r.publisherRecommendation = pub[1].trim();
                const pr = md.match(/#### 公关回应建议[\s\S]*?\n\s*(.+?)\s*$/);
                if (pr) r.recommendation = pr[1].trim();
                return r;
            }

            function displayResults(data) {
                // 保留你原来的饼图，不改成彩条
                createCredibilityChart(data.credibility || 8.5);
                document.getElementById('report-title').textContent = data.title || '分析文章';
                document.getElementById('credibility-score').textContent = `${data.credibility || 8.5} / 10`;
                document.getElementById('credibility-reason').textContent = data.reason || '内容分析完成';

                const factsList = document.getElementById('facts-list');
                factsList.innerHTML = data.facts.length ? data.facts.map((f, i) => `<div class="text-sm text-gray-700 bg-blue-50 p-3 rounded-lg">${i + 1}. ${f}</div>`).join('') : '<div class="text-sm text-gray-500">未检测到明确的事实陈述</div>';
                const opList = document.getElementById('opinions-list');
                opList.innerHTML = data.opinions.length ? data.opinions.map((o, i) => `<div class="text-sm text-gray-700 bg-green-50 p-3 rounded-lg">${i + 1}. ${o}</div>`).join('') : '<div class="text-sm text-gray-500">未检测到明确的观点表达</div>';

                document.getElementById('emotional-words').textContent = `${data.bias?.emotionalWords || 0} 处`;
                document.getElementById('binary-opposition').textContent = `${data.bias?.binaryOpposition || 0} 组`;
                document.getElementById('motivation-guessing').textContent = `${data.bias?.motivationGuessing || 0} 处`;
                document.getElementById('overall-tendency').textContent = data.bias?.overallTendency || '中性 0%';

                document.getElementById('publisher-recommendation').textContent = data.publisherRecommendation || '建议提升内容质量';
                document.getElementById('pr-recommendation').textContent = data.recommendation || '建议谨慎处理';
            }

            function createCredibilityChart(score) {
                const data = [{
                    values: [score, 10 - score],
                    labels: ['可信度', ''],
                    type: 'pie',
                    hole: 0.7,
                    marker: { colors: ['#3b82f6', '#e5e7eb'] },
                    textinfo: 'none',
                    hoverinfo: 'none',
                    showlegend: false
                }];
                const layout = { width: 200, height: 200, margin: { t: 0, b: 0, l: 0, r: 0 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', annotations: [{ text: `<b>${score}</b><br><span style="font-size:14px">/ 10</span>`, x: 0.5, y: 0.5, font: { size: 24, color: '#3b82f6', family: 'JetBrains Mono' }, showarrow: false }] };
                const config = { displayModeBar: false, responsive: true };
                Plotly.newPlot('credibility-chart', data, layout, config);
            }
        });
    </script>
</body>
</html>
